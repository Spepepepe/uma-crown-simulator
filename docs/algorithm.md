# 育成パターン計算アルゴリズム

実装: [backend/src/race/race-pattern.service.ts](../backend/src/race/race-pattern.service.ts)

## 問題の背景

全冠対象レースは **155個**、育成で出走できるターン（スロット）は**最大 60**（ジュニア 12 + クラシック 24 + シニア 24）です。
1回の育成ですべてを消化することは不可能なため、残レースを複数の育成ローテーションに分配する必要があります。

さらに以下の制約が絡み合います。

- 同一スロット（月・前後半）には 1レースしか出走できない
- 連続 4 戦以上の出走は禁止（ゲームルール）
- シナリオ（伝説）では特定レースが目標として固定される
- L'Arc（ラーク）シナリオはクラシック 7〜10 月・シニア 6 月後半以降の自由出走が禁止

---

## 実装 1：旧実装の問題点（逐次 Greedy）

初期実装は「1パターンのスロットを前から順に埋めていく」逐次 Greedy 方式でした。
**前詰め問題**があり、早いスロットにレースが集中して後半のパターンに偏りが生じ、パターン数が過剰になるという欠点がありました。

---

## 実装 2：グリッドベース一括割り当て（BC 導入前）

### Phase 1 — スロット圧力によるパターン数の決定

各残レースは走れる期（ジュニア / クラシック / シニア）に応じてスロットに**ウェイト**を分配します。

```
classic のみ出走可  → そのスロットに weight = 1.0
classic + senior 両方 → 各スロットに weight = 0.5
```

全スロットのウェイト合計（**圧力**）を求め、最大値の `ceil` が必要メイクラパターン数になります。

```
Nメイクラ = ceil( max(圧力[S]) for all S )
N合計     = Nメイクラ + (シナリオレースが存在すれば +1)
```

### Phase 2 — グリッドへの一括割り当て

`Grid[patternIndex][slotKey]` という 2 次元構造に対して全残レースを一括で割り当てます。
割り当て順は「配置できるスロットが少ない（制約が厳しい）レースを先に」とし、各候補に以下のスコアを付けて最良手を選択します。

| スコア要素 | 概要 |
|-----------|------|
| 因子戦略一致 | ウマ娘の不足因子（バ場・距離）と一致すれば +2〜+4 |
| 連続出走抑制 | 前後のスロットへの連続配置が長いほど減点 |
| グレード優先 | G1 > G2 > G3 の順に優先配置 |

### Phase 3 — パターン後処理

グリッドから各パターンのスロット配列（junior / classic / senior）を構築し、
ラーク変換判定・シナリオ名確定（伝説 / ラーク / メイクラ）・因子構成計算・主バ場/距離の集計を行います。

### 制約の実装（BC 導入前）

| 制約 | 処理 |
|------|------|
| 連続 4 戦禁止 | スロット線形順序（60スロット通し番号）上で隣接スロットを走査し、連続長が 3 以上になる配置を禁止。シナリオ固定レースはカウント対象外 |
| L'Arc 制限スロット | ラーク候補パターンでは classic 7〜10 月前半・senior 6 月後半以降への通常レース配置を禁止 |
| シナリオレース分離 | 通常割り当て対象から除外し、伝説パターン（index=0）に固定配置 |

---

## 実装 3：BC シナリオ対応拡張（2026年2月）

### ゲームアップデートの経緯

2026年2月のアップデートで **BC（Breeders' Cup）シナリオ**が追加された。
これにより育成の最終目標として 9 種類の BC 最終レースが選択可能となり、
それぞれに**必須中間レース 4 本**が紐付く「ルート」構造が生まれた。

BC 最終レースはすべて **シニア 11 月前半の同一スロット**に集まる。
すなわち 1 回の育成で狙えるのは 9 種のうち 1 つだけであり、
どれを選ぶかによって必須中間レースが変わり、ウマ娘の適性・因子戦略とも密接に連動する。

| BC 最終レース | 必須中間レース（4 本） |
|---|---|
| BCターフ | ホープフルS・日本ダービー・ジャパンC・宝塚記念 |
| BCフィリー＆メアターフ | 阪神ジュベナイルF・オークス・エリザベス女王杯・ヴィクトリアマイル |
| BCターフスプリント | 京王杯ジュニアS・葵S・スプリンターズS・高松宮記念 |
| BCマイル | 朝日杯FS・NHKマイルC・マイルCS・安田記念 |
| BCスプリント | オキザリス賞・昇竜S・JBCスプリント・根岸S |
| BCフィリー＆メアスプリント | オキザリス賞・昇竜S・JBCスプリント・根岸S |
| BCダートマイル | 全日本ジュニア優駿・ユニコーンS・マイルCS南部杯・フェブラリーS |
| BCディスタフ | 全日本ジュニア優駿・関東オークス・JBCレディスクラシック・TCK女王盃 |
| BCクラシック | 全日本ジュニア優駿・ジャパンダートダービー・JBCクラシック・帝王賞 |

### 設計上の課題と判断

BC 追加により、従来の「スロット圧力でパターン数を決定 → 一括割り当て」という 3 フェーズでは対応できない問題が生じた。

1. **パターン数の決定基準が変わった**
   BC 前は「残レースを何パターンに分散するか」がスロット圧力で決まった。
   BC 後は「まだ走っていない BC 最終レースが何種あるか」が先に決まり、
   それをベースに残レースを配分する構造になった。

2. **BC ルート固有のスロット占有**
   BC 最終（5 本分）が固定されるため、通常レースとの割り当てを分離する必要があった。
   また BC 必須中間レースは **出走済みでもルート参照として表示**する仕様にした
   （BC 前の伝説シナリオレースと同じ考え方）。

3. **A/B パターン分類の導入**
   ウマ娘の適性と BC 最終レースの馬場・距離が合わない場合、因子補修が必要になる。
   この補修を「因子戦略」として定義し、割り当てスコアに反映することで
   適性向上に役立つレースを優先配置できるようにした。

   | パターン | 適性条件 | 因子戦略 |
   |---|---|---|
   | **A パターン** | 馬場または距離の適性が C 未満 | 補修因子を戦略として設定 |
   | **B パターン** | 馬場・距離ともに C 以上 | 戦略なし（自然適性で走れる） |

4. **オーバーフロー時のスロット圧力は `floor`（繰り下げ）を採用**
   BC パターンへの割り当て後に残レースが余った場合、追加パターンを生成する必要がある。
   ここではスロット圧力を再利用するが、すでに多くのスロットが埋まっている段階なので
   `ceil`（切り上げ）ではなく `floor`（切り捨て）を採用し、過剰なパターン生成を抑制した。

### 新アルゴリズム全体構成（9 フェーズ）

#### Phase 1 — データ取得

| データ | 内容 |
|---|---|
| `allGRaces` | 全 G1/G2/G3 レース（BC 最終レースを含む） |
| `allBCMandatoryRaces` | BC 必須中間レース全件（**出走済みを含む**） |
| `remainingRacesAll` | 未出走レース（`allGRaces` から出走済みを除外） |
| `hasRemainingLarc` | 凱旋門賞・ニエル賞・フォワ賞等が未出走かどうか |

#### Phase 2 — BC パターン数の決定

```
nBC = 未出走 BC 最終レース数（0〜9）
```

スロット圧力ではなく**残 BC 数がそのままパターン数**になる。

#### Phase 3〜5 — BC パターン初期化

A パターン（補修あり）→ B パターン（補修なし）の順に BC 最終レースをソートし、
各パターングリッドに BC 最終・必須中間レースを固定配置する。
必須中間レースは出走済みでも `allBCMandatoryRaces`（全件）から配置することで
ルート全体が常に可視化される。

#### Phase 6 — 残レース一括割り当て

実装 2 のグリッドベース割り当てをそのまま継承し、BC スコアリングを追加拡張する。

| スコア要素 | 概要 |
|---|---|
| 適性一致 | BC 最終レースと同じ馬場・距離なら +10 |
| 因子補修で走れる | 空き因子スロットで D まで引き上げ可能なら +1 |
| 因子戦略未決定 | 補修レースの割り当てにより戦略が確定するなら +2 |
| 連続出走抑制 | 連続配置が長いほど減点 |
| グレード優先 | G1 > G2 > G3（+3 / +2 / +1） |

#### Phase 7 — オーバーフロー BC パターン生成

Phase 6 後も未割り当て残レースがある場合、追加 BC パターンを生成する。
内部は 6 サブフェーズで構成される。

```
フェーズ1: 残レースから BC 中間レースを抽出・除外
フェーズ2: BC 中間レースが属する BC 最終レース種類数 nBCFromIntermediate を算出
フェーズ3: 残レース（BC 中間除外後）のスロット圧力でパターン数を算出（繰り下げ）
          nFromWeight = floor( max(圧力[S]) for all S )
          N = max(nBCFromIntermediate, nFromWeight)
フェーズ4: N パターン初期化
          - 先頭 nBCFromIntermediate 個: BC 最終・中間・戦略・適性を設定
          - 残りパターン: 戦略 null・初期適性
フェーズ5: assignRacesToBCGrids で全 N パターンへ一括割り当て
フェーズ6: BC 未設定パターンに適性で走れる BC シナリオを設定
```

#### Phase 8 — ラークパターン生成

凱旋門賞等のラーク関連レースが残存する場合にラーク専用パターンを追加する。
LARC_MANDATORY レース（日本ダービー・宝塚記念・凱旋門賞等）は
**`allGRaces`（出走済み含む全件）から検索して強制配置**する。
これは BC 必須中間レースと同じ設計方針であり、
出走済みであっても「ラークルートの参照」として常に表示させるためである。

#### Phase 9 — パターン後処理

因子構成（6 枠）の計算方針：

| ケース | 方針 |
|---|---|
| 戦略あり（A パターン） | 戦略因子を先に配置し、残スロットをダート/芝優先で補完 |
| 戦略なし（B パターン） | パターン内の走行レースから適性不足を自動算出して補修 |
| ラーク | シナリオ補正で芝・中距離は A 相当のため、それ以外を補完 |
| 共通 | 補完できないスロットは「自由」で埋め、計 6 枠に整形 |

### 制約の実装（BC 対応後）

| 制約 | 処理 |
|------|------|
| 連続 4 戦禁止 | スロット線形順序（60スロット通し番号）上で隣接スロットを走査し、連続長が 3 以上になる配置を禁止 |
| BC 制限スロット | シニア 11 月後半・12 月への通常レース配置を禁止 |
| BC 必須中間レース | 通常割り当て対象から除外し、各 BC パターンに固定配置（出走済みでも参照表示） |
| L'Arc 制限スロット | ラーク候補パターンではクラシック 5 月後半・7〜9 月・10 月前半、シニア 6 月後半以降を禁止 |
| ラーク必須レース | 通常割り当て対象から除外し、ラークパターンに固定配置（出走済みでも参照表示） |

---

## 参考

- Qiita 記事: [ウマ娘の全冠称号を効率化！レースパターン計算機能を作ってみた](https://qiita.com/spepepepe/items/98263fe0637ac280d7a7)